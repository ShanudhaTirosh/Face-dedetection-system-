<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Register System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/face-api.js/0.22.2/face-api.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #74ebd5, #9face6);
            min-height: 100vh;
            padding: 2rem 0;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .camera-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        #camera {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }

        #face-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .face-item {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading-screen">
        <h3>Loading Face Detection Models...</h3>
    </div>

    <div class="container">
        <div class="glass-effect p-4 rounded">
            <h2 class="text-center mb-4">Face Register System</h2>
            
            <div class="camera-container mb-3">
                <video id="camera" autoplay playsinline></video>
                <canvas id="face-canvas"></canvas>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <input type="text" id="face-name" class="form-control mb-2" placeholder="Enter name">
                </div>
                <div class="col-md-6">
                    <input type="text" id="face-id" class="form-control mb-2" placeholder="Enter ID">
                </div>
            </div>

            <div class="d-flex justify-content-center mb-3 flex-wrap gap-2">
                <button id="start-detection" class="btn btn-primary">Start Detection</button>
                <button id="add-face" class="btn btn-success" disabled>Add Face</button>
                <button id="export-data" class="btn btn-warning">Export Data</button>
                <button id="clear-data" class="btn btn-danger">Clear All Data</button>
            </div>

            <div id="face-list" class="mt-3"></div>
        </div>
    </div>

    <script>
        // Initialize variables
        const video = document.getElementById('camera');
        const canvas = document.getElementById('face-canvas');
        const faceList = document.getElementById('face-list');
        const startDetection = document.getElementById('start-detection');
        const addFace = document.getElementById('add-face');
        const exportData = document.getElementById('export-data');
        const clearData = document.getElementById('clear-data');
        const faceNameInput = document.getElementById('face-name');
        const faceIdInput = document.getElementById('face-id');
        const loadingScreen = document.getElementById('loading');

        let db;
        let detectedFace = null;
        let detectionInterval;

        // Initialize IndexedDB
        const initDB = () => {
            const request = indexedDB.open('FaceDatabase', 1);
            
            request.onupgradeneeded = (event) => {
                db = event.target.result;
                const store = db.createObjectStore('faces', { keyPath: 'id', autoIncrement: true });
                store.createIndex('faceId', 'faceId', { unique: true });
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                updateFaceList();
            };

            request.onerror = (event) => {
                console.error("IndexedDB error:", event.target.error);
                alert("Database error: " + event.target.error);
            };
        };

        // Load face-api.js models
        const loadModels = async () => {
            try {
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                await faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                await faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                loadingScreen.style.display = 'none';
                initCamera();
            } catch (error) {
                console.error('Error loading models:', error);
                alert('Error loading face detection models. Please refresh the page.');
            }
        };

        // Initialize camera
        const initCamera = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                // Set canvas size after video loads
                video.addEventListener('loadedmetadata', () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                });
            } catch (error) {
                console.error('Camera error:', error);
                alert('Unable to access camera. Please ensure camera permissions are granted.');
            }
        };

        // Start face detection
        startDetection.addEventListener('click', async () => {
            if (!faceNameInput.value || !faceIdInput.value) {
                alert('Please enter both name and ID');
                return;
            }

            if (detectionInterval) {
                clearInterval(detectionInterval);
                startDetection.textContent = 'Start Detection';
                addFace.disabled = true;
                detectedFace = null;
                return;
            }

            startDetection.textContent = 'Stop Detection';
            
            detectionInterval = setInterval(async () => {
                const detections = await faceapi.detectAllFaces(
                    video,
                    new faceapi.TinyFaceDetectorOptions()
                ).withFaceLandmarks().withFaceDescriptors();

                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (detections.length > 0) {
                    detectedFace = detections[0];
                    addFace.disabled = false;

                    // Draw detection box
                    ctx.beginPath();
                    ctx.lineWidth = "3";
                    ctx.strokeStyle = "green";
                    const box = detections[0].detection.box;
                    ctx.rect(box.x, box.y, box.width, box.height);
                    ctx.stroke();
                } else {
                    detectedFace = null;
                    addFace.disabled = true;
                }
            }, 100);
        });

        // Add detected face to database
        addFace.addEventListener('click', async () => {
            if (!detectedFace || !faceNameInput.value || !faceIdInput.value) {
                alert('Please ensure face is detected and all fields are filled');
                return;
            }

            const faceData = {
                faceId: faceIdInput.value,
                name: faceNameInput.value,
                descriptor: Array.from(detectedFace.descriptor),
                timestamp: new Date().toISOString()
            };

            const transaction = db.transaction(['faces'], 'readwrite');
            const store = transaction.objectStore('faces');

            try {
                await store.add(faceData);
                alert('Face registered successfully!');
                faceNameInput.value = '';
                faceIdInput.value = '';
                updateFaceList();
            } catch (error) {
                alert('Error adding face. ID might be duplicate.');
            }
        });

        // Update face list in UI
        const updateFaceList = () => {
            const transaction = db.transaction(['faces'], 'readonly');
            const store = transaction.objectStore('faces');
            const request = store.getAll();

            request.onsuccess = (event) => {
                const faces = event.target.result;
                faceList.innerHTML = faces.map(face => `
                    <div class="face-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>ID:</strong> ${face.faceId}<br>
                                <strong>Name:</strong> ${face.name}<br>
                                <strong>Registered:</strong> ${new Date(face.timestamp).toLocaleString()}
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="deleteFace('${face.faceId}')">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            };
        };

        // Delete face from database
        window.deleteFace = (faceId) => {
            if (confirm('Are you sure you want to delete this face?')) {
                const transaction = db.transaction(['faces'], 'readwrite');
                const store = transaction.objectStore('faces');
                const index = store.index('faceId');
                
                const request = index.getKey(faceId);
                request.onsuccess = (event) => {
                    const key = event.target.result;
                    store.delete(key);
                    updateFaceList();
                };
            }
        };

        // Export data to CSV
        exportData.addEventListener('click', () => {
            const transaction = db.transaction(['faces'], 'readonly');
            const store = transaction.objectStore('faces');
            const request = store.getAll();

            request.onsuccess = (event) => {
                const faces = event.target.result;
                const csvContent = "data:text/csv;charset=utf-8," + 
                    "ID,Name,Registration Date\n" +
                    faces.map(face => `${face.faceId},${face.name},${face.timestamp}`).join("\n");

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "face_register_data.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
        });

        // Clear all data
        clearData.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all face data? This cannot be undone.')) {
                const transaction = db.transaction(['faces'], 'readwrite');
                const store = transaction.objectStore('faces');
                store.clear();
                updateFaceList();
            }
        });

        // Initialize application
        loadModels();
        initDB();
    </script>
</body>
</html>
